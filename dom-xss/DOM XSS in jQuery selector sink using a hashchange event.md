
## 1. معلومات عامة

| العنصر         | التفاصيل                                                                                                                |
| -------------- | ----------------------------------------------------------------------------------------------------------------------- |
| **الرابط**     | [رابط اللاب](https://portswigger.net/web-security/cross-site-scripting/dom-based/lab-jquery-selector-hash-change-event) |
| **تاريخ الحل** | 27/4                                                                                                                    |
| **نوع الثغرة** | DOM-Based XSS                                                                                                           |

----
## 1. الفكرة العامة لللاب

- الموقع فيه صفحة فيها مقالات (blogs).
- الموقع بيستخدم **`location.hash`** عشان يحدد عنوان المقال اللي يعمل عليه **scroll** تلقائي.
- الكود اللي بيعمل كده:

```js
$(window).on('hashchange', function () {
var post = $('section.blog-list h2:contains(' + decodeURIComponent(window.location.hash.slice(1)) + ')');
if (post.length) {
post.get(0).scrollIntoView();
}
});
```

هذا الكود مكتوب بلغة JavaScript باستخدام مكتبة jQuery، والغرض منه تسهيل التنقل بين المقالات في المدونة عن طريق تغيير الـ hash في عنوان URL. إليك الشرح التفصيلي:

### 1. **الحدث المُستمع له:**
```javascript
$(window).on('hashchange', function () { ... });
```
- **الوظيفة:** يستمع لتغييرات في **hash** عنوان الصفحة (الجزء بعد `#` في الرابط، مثل `#مقال-1`).
- **مثال:** عند النقر على رابط يحتوي على هاش جديد، أو استخدام أزرار التقديم/الرجوع في المتصفح.

---

### 2. **فك تشفير الهاش:**
```javascript
decodeURIComponent(window.location.hash.slice(1))
```
- **`window.location.hash`:** يسترجع الهاش الحالي (مثل `#مقال-1`).
- **`.slice(1)`:** يزيل علامة `#` ليبقى النص فقط (`مقال-1`).
- **`decodeURIComponent()`:** يفك تشفير النص المُشفّر في الرابط (مثل تحويل `%20` إلى مسافة).

---

### 3. **البحث عن المقال المناسب:**
```javascript
$('section.blog-list h2:contains(' + ... + ')')
```
- **الهدف:** يبحث عن عنصر `<h2>` داخل قسم المدونة (`section.blog-list`) يحتوي على **نص مطابق للهاش**.
- **`:contains()`:** مُحدّد في jQuery للعثور على عناصر تحتوي على نص معين.

---

### 4. **التمرير إلى المقال:**
```javascript
if (post.length) {
  post.get(0).scrollIntoView();
}
```
- **الشرح:** إذا وُجد العنصر (`post.length > 0`):
  - **`post.get(0)`:** يحوّل العنصر المحدد بـ jQuery إلى عنصر DOM عادي.
  - **`scrollIntoView()`:** يمرر الصفحة ليظهر العنصر في واجهة المستخدم.

---

### **مثال عملي:**
- **الرابط:** `https://example.com/blog#كيفية-برمجة-موقع`
- **عند التحميل:** يبحث الكود عن عنوان `<h2>` يحتوي على "كيفية-برمجة-موقع" ويُمرر الصفحة إليه.

**خطورة هنا:**  
انت بتتحكم في **location.hash**، وهو بيتحط **مباشرة** جوا **`$('selector')`** بدون أي فلترة أو معالجة صح، وده بيؤدي لـ **DOM-Based XSS**.

---

## 2. طيب يعني ايه المشكلة بالظبط؟

لما تكتب في الـ URL مثلا:

```
https://example.com/#something
```

هيحاول الموقع يدور على عنوان (`<h2>`) فيه الكلمة "something".

بس لو كتبت في الـ hash حاجة فيها أكواد HTML أو JavaScript ذكية، ممكن تتحول لجوا الموقع، ويبقى فيه تنفيذ كود.

بس خلي بالك: مش أي كود ينفع!

ليه؟

- الكود جوة `$('section.blog-list h2:contains(...)')`
- يعني هو بيدور على **نص داخل عنوان**، مش بيحقن HTML صريح.

**يبقى الحقن المباشر مش سهل.**

---

## 3. ليه مينفعش تحط البايلود مباشرة في اللينك؟

لأنك لو عملت كده:

```
https://YOUR-LAB-ID.web-security-academy.net/#<img src=x onerror=print()>
```

الموقع مش بيحط الـ hash كـ **HTML** جوة الصفحة.  
هو بيستخدمها **جوا سيلكتور jQuery**.

يعني بيترجمها بالشكل ده تقريبا:

```javascript
$('section.blog-list h2:contains(<img src=x onerror=print()>)')
```

ودي مش بتخلي `<img>` يتنفذ!  
الجافاسكريبت هيبحث عن عنوان h2 فيه النص الحرفي `<img src=x onerror=print()>`، مش هيحطلك عنصر `<img>` في الصفحة.

بالتالي:  
**لازم تلاقي طريقة تخلّي الكود "يتفسر" جوة الصفحة أو جوة السيلكتور بشكل ذكي.**

---

## 4. طيب ليه حطينا كود `iframe` بدلًا من لينك مباشر؟

الحل هنا معتمد على:

- نفتح الصفحة بشكل طبيعي (`#` بس، يعني hash فاضي).
- أول لما الصفحة تفتح، نعدل الـ `src` بتاع الـ `iframe` ونضيف فيه الكود الشرير.

الكود اللي انت هتستخدمه:

```html
<iframe src="https://YOUR-LAB-ID.web-security-academy.net/#" onload="this.src+='<img src=x onerror=print()>'"></iframe>
```

### تفصيله:

- iframe يفتح الموقع مع `#` فاضي:  
    يعني مفيش خطر دلوقتي، الصفحة بس بتفتح.
    
- بعد ما الـ iframe يعمل `onload` (يعني اتحمل)، الكود ده يتنفذ:
    
    ```javascript
    this.src += '<img src=x onerror=print()>';
    ```
    
    اللي بيعمل إيه؟
    
    - بياخد عنوان الصفحة (`src` الحالي) ويضيف عليه الكود الشرير (`<img src=x onerror=print()>`).
    - يعني بيغير الهاش عن طريق جافاسكريبت!
- ولأن الصفحة بترصد أي **hashchange** (`$(window).on('hashchange', function() {...})`)،  
    أول لما يتغير الهاش، الكود في الموقع يتنفذ تلقائي.
    

---
# ليه النص العادي يشتغل بالـ link العادي (وينزلك للبوست)، والـ payload يشتغل بس عن طريق مسار الـ iframe ؟

## 1. لغة الـ jQuery selector والـ CSS الصالح

- **نص عادي** (مثلاً “MyPost”) هو **سيلكتور CSS صالح** داخل
    
    ```js
    $('section.blog-list h2:contains(MyPost)')
    ```
    
    ✔️ Sizzle (محرك jQuery للselectors.) يتقبله من غير مشاكل ويرجع لك عنصر الـ `<h2>` الموجود بالفعل في الصفحة.
    
- **بايلود** فيه `<img …>` هو **سيلكتور غير صالح** ــ بيحتوي علامات HTML داخل قوس `:contains()` ➔ Sizzle يرمي خطأ.
    

---

## 2. مساران للتعامل مع الخطأ في jQuery Migrate

1. **النص العادي**: لا غلطة ← المسار العادي ← يلاقي البوست ويعمل `scrollIntoView()`.
    
2. **البايلود**: يغلط ← Migrate “يلتقط” الغلطة ويقول: “خليني أحول النص لـ HTML” ← تشكّل عندك عنصر `<img>` ← onerror ينفّذ `print()`.
    

---

## 3. لماذا “الرابط العادي” يشتغل للنص العادي؟

- الروابط الموجودة تحت كل بوست (View post) هي `<a href="#عنوان البوست">` داخل الصفحة نفسها.
    
- **النقر على هذا الرابط** يغيّر الـ hash **ديناميكيّاً** من دون إعادة تحميل → يطلق `hashchange` → الكود يشتغل على المسار الأول (selector صالح) → ينزلك للعنصر.
    

---

## 4. لماذا البايلود يحتاج iframe ؟

- لو **فتحت الصفحة برابط خارجي فيه البايلود** (`https://…/#payload`) ← هذا تحميل أولي مع الهاش ← لم يحدث “تغيير” بعد ربط الـ event ← `hashchange` **لا ينطلق** ← لن تشتغل لا مسار selector ولا مسار fallback.
    
- أما إذا استخدمت **iframe** :
    
    - الصفحة تُحمّل أوّلاً بدون هاش
        
    - ثم يُغيّر الهاش **ديناميكيّاً** داخل السياق (الصفحة أو الـ iframe)
        
    - يحصل `hashchange` → الكود يشتغل → يمرّ في fallback ويطلق `print()`.
        

--- 
# هااااااااااااام
### الخلاصة العملية

- **النص العادي + رابط داخلي** ← حدث ديناميكي ← selector صالح ← scroll.
    
- **بايلود + تحميل أولي** ← لا حدث ← لا تنفيذ.
    
- **بايلود + تغيير ديناميكي** (iframe/console/anchor داخل الصفحة) → حدث → selector يرمي خطأ → Migrate يحوّل لـ HTML → onerror ينفّذ بايلود.
---

## 6. الخطوات النهائية:

- تفتح **Exploit Server**.
- تحط الكود ده في الـ **Body**:

```html
<iframe src="https://YOUR-LAB-ID.web-security-academy.net/#" onload="this.src+='<img src=x onerror=print()>'"></iframe>
```

- تخزن الـ exploit.
- تعمل **View exploit** --> لو شفت الـ print() اشتغل --> انت تمام.
- بعد كده تضغط **Deliver to victim** --> لو الضحية شافه واشتغل --> انت حليت اللاب.


---

# شرح اضافي

لما بتحط كلمة عادية بعد الـ `#` ويبقى نفس الكلمة موجودة في عناوين الـ `<h2>` على الصفحة، بتحصل ثلاث حاجات بسيطة:

1. **أنت فعّلت “hashchange”**
    
    - فرضاً فتحنا الصفحة بدون هاش (`https://site.com/`)، وبعدها غيّرت الهاش يدوياً في الـ URL →
        
        ```js
        window.location.hash = "MyPost";
        ```
        
    - هذا تغيير ديناميكي في الـ fragment، فـ الحدث `hashchange` اللي ربطناه بـ jQuery “ينطلق” فعلاً.
        
2. **jQuery تشغل الـ selector على شكل CSS صالح**
    
    - الكود يبنِي التعبير ده بالضبط:
        
        ```js
        $('section.blog-list h2:contains(MyPost)')
        ```
        
    - لأن `"MyPost"` نص عادي، التعبير ده هو سيلكتور CSS صحيح تماماً، Sizzle (محرك jQuery للسيليكتورز) يفتحه بدون مشاكل ويلاقي العنصر `<h2>` اللي فيه الكلمة دي.
        
3. **تلاقي العنصر في الصفحة وتعمل له scrollIntoView**
    
    - بما إن `post.length > 0`، ينادي
        
        ```js
        post.get(0).scrollIntoView()
        ```
        
    - النتيجة: الصفحة بتنزل لعنوان البوست المطلوب.
        

---

## ليه الـ payload ما يشتغلش بنفس الطريقة؟

1. **الـ payload فيه `<` و `>` – مش نص عادي**
    
    - مثال:
        
        ```
        anything')<img src=x onerror=print()>
        ```
        
    - لما تحطه داخل:
        
        ```js
        $('section.blog-list h2:contains(anything')<img src=x onerror=print()>')
        ```
        
        التعبير ده مش سيلكتور CSS صالح (فيه تاج HTML جوّه).
        
2. **jQuery يحاول يفتح السيلكتور، يلاقي غلطة، ويرمي exception**
    
    - هنا تدخل مكتبة jQuery Migrate وتقول:
        
        > “ماشي، بدل ما ننهي الصفحة بالغلط ده، خلّينا نحاول نعامل السلسلة كـ HTML”
        
    - فـ تنادي `jQuery.parseHTML()` على النص ده وتحوّله إلى عنصر `<img>` فعلي.
        
3. **الـ `<img>` يشتغل، يحقن في الذاكرة، ومافيش scroll للأسباب اللي تحت**
    
    - المتصفح يحاول يحمل الصورة من `src="x"` → يفشل → يطلق `onerror` → ينفّذ `print()`.
        
    - بعدين `post.length` يكون > 0 (لأن الـ parseHTML أرجع nodes)، فينادي `scrollIntoView()` على أول node (الـ `<img>`).
        
    - لكن لأن هذا العنصر مش مضاف فعلياً داخل الـ DOM الرئيسي، مش هتشوف أي scroll حقيقي.
        

---

### الخلاصة

- **كلمة موجودة في الصفحة = سيلكتور CSS صالح → يلاقي العنصر → ينزلك عليه**
    
- **payload فيه `<img>` = سيلكتور فاشل → jQuery Migrate fallback لـ HTML → ينفّذ onerror → print()**


